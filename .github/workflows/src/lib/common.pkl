open module common
extends "base.pkl"

hidden checkout = new ActionStep {
    uses = "actions/checkout@v4"
    with = new Mapping {
        ["fetch-depth"] = 0
    }
}

hidden currentNginxVersion: Step = new CommandStep {
    name = "Get current latest nginx version"
    run = """
    echo "NGINX_VERSION=$(cat nginx-version)" >> $GITHUB_ENV
    """
}

hidden dockerBuild: Step = new ActionStep {
    name = "Build and push Docker image"
    uses = "docker/build-push-action@v6"
}

hidden dockerSetup: Listing<Step> = new Listing {
    new ActionStep {
        name = "Setup QEMU"
        uses = "docker/setup-qemu-action@v3"
    }
    new ActionStep {
        name = "Setup Docker Buildx"
        uses = "docker/setup-buildx-action@v3"
    }
    new ActionStep {
        name = "Log in to the Container registry"
        uses = "docker/login-action@v3"
        with = new Mapping {
            ["registry"] = "https://ghcr.io"
            ["username"] = "${{ github.actor }}"
            ["password"] = "${{ secrets.GITHUB_TOKEN }}"
        }
    }
}